# .github/workflows/python-app.yml

name: API Integration Tests

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  integration-test:
    runs-on: ubuntu-latest
    
    # 1. Start the API as a service (simulating deployment to a staging environment)
    services:
      api:
        image: python:3.9-slim  # Use a minimal Python image for the server
        options: --name api_service  # Give it a name for host lookup
        ports:
          - 5000:5000
        
        # CORRECT YAML: Use bash -c to run multiple commands in a single string for the service.
        command: ["bash", "-c", "pip install Flask && python api.py"]
          
    steps:
    # 2. Checkout the repository code
    - uses: actions/checkout@v4
      
    # 3. Install Node.js
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    # 4. Install Newman (the test runner)
    - name: Install Newman
      run: npm install -g newman
      
    # 5. Wait for API to start and run tests
    - name: Wait for API and Run Newman Tests
      run: |
        # Wait a moment for Flask to fully start inside the service container
        sleep 5 
        # Run the Newman tests against the service container host 'api'
        # The service name 'api' is the hostname to use inside the workflow.
        newman run integration-tests.json \
        --global-var "baseURL=http://api:5000"
      env:
        CI_RUN: true